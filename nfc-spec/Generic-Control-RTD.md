# Generic Control Record Type Definition



## Generic Control

通用控制RTD提供了一种简单的, 可以通过NFC通信从一个NFC论坛设备, 标签或卡 (源设备) 向NFC论坛设备 (目标设备) 虚拟请求任何特定操作的方法. 

它的设计理念是:

* 访问MIME类型记录或其他NFC论坛全局类型记录未涵盖的功能或应用程序.
* 源设备明确指示目标设备上的特定功能或特定应用程序以执行特定操作.

## NDEF Structure



### Record Mapping

通用控制载荷的内容是一个 NDEF 消息.

一个控制记录包含如下组件:

* 一个配置字节: 用于指定多个配置文件, 以帮助确定如何处理其余的载荷
* 目标记录: 用于标识处理通用控制记录中包含的数据的功能.
* 动作记录: 用于为目标记录所标识的功能指定处理数据的动作.
* 数据记录: 用于指定要由目标记录标识的功能处理的数据.

通用控制记录的结构图:

![image-20200712214341381](/Users/wangzhijun/me/gitbook/nfc/nfc-spec/Generic-Control-record.png)

说明:

通用控制记录的类型定义中没有定义子记录 - 目标记录, 动作记录, 数据记录 - 的顺序. 一般建议先指定目标记录, 在后指定动作记录, 再指定数据记录.

* "Gc": 通用控制记录类型的作为总所周知类型(The Well-known Type)的名称. 采样 NFC 二进制编码为: 0x47, 0x63.
* Config Byte: 配置字节. 是 "Gc" 记录的载荷的第一个字节. 其位域的含义见表-Config-Byte. 
* "t": 目标记录的类型名. 
* "a": 操作记录的类型名.
* "d": 数据记录的类型名.

表-Config-Byte:

| Bit  | 名称     | 符号 | 解释                                     |
| ---- | -------- | ---- | ---------------------------------------- |
| 0    | 保留     | -    | 必须为 0                                 |
| 1    | 顺序控制 | SC   | 1: 检查退出条件.                         |
| 2    | 顺序控制 | EC   | 1: 当这条记录未处理成功, 则忽略后续记录. |
| 3..7 | 保留     |      | 必须为 0                                 |

### 多条记录的顺序控制

当顶层的 NDEF 消息中包含多条通用控制记录, 建议假定这些记录期望以先进先出(FIFO) 的方式处理. 只应有一条通用控制记录出现在顶级 NDEF 消息中.

配置字节中的顺序控制标志指明了在多个通用控制记录处理过程中如何终止的条件.

### 子记录

以下的记录类型作为本地类型定义. 作用域仅限于一条通用控制记录里.

#### 目标记录

类型名为 "t" (0x74). 一条通用控制记录必须包含一条且仅包含一条目标记录. 目标记录包含一个 Text RTD[[RTD-text]] 记录或者 URI RTD 记录. 目标设备应负责子记录内容的翻译. 如果目标设备不理解子记录的内容, 则目标设备应只忽略包含未解析目标记录的通用控制记录.

#### 动作记录

类型名为 "a"(0x61). 它指定目标函数处理数据所需的动作. 一条通用控制记录最多包含一条动作记录. 当省略动作记录时, 可以应用该功能的默认动作. 默认动作取决于每个功能. 如果用目标记录或目标设备的所有实体都不理解动作记录的内容, 则应该简单地忽略通用控制记录. 对动作记录内容的解释取决于目标功能. 

在动作记录的载荷中包含一个动作记录标志字节和一个数据记录.

动作 Flag 字节:

| Bit  | 名称                   | 符号 | 含义                                                         |
| ---- | ---------------------- | ---- | ------------------------------------------------------------ |
| 0    | 数值代码(Numeric Code) | NC   | 1: 使用数值代码指定动作(数值代码见表-Numeric-Code)<br>0: 余下的载荷中包含一条完整的 NDEF 记录, 比如: 文本记录, MIME 类型记录等. 目标函数应能够解释数据以执行预期的动作. |
| 1..7 | 保留                   | -    | 必须为 0                                                     |

表-Numeric-Code:

| 值    | 含义                                                         |
| ----- | ------------------------------------------------------------ |
| 0     | 目标函数的默认动作. (例如: 在浏览器中打开网页. 拨打电话等)   |
| 1     | 保存. (例如: 添加 URL 到Web 浏览器中, 存储作为电话号码的数据到联系人列表中等等) |
| 2     | 打开进行编辑. (例如: 将数据作为电话联系人, 在联系人编辑器中打开) |
| 3..FF | 保留                                                         |

注意: 仅当目标函数能够处理上述代码时, 数值代码才有效. 如果一个函数收到上述代码之一, 但是无法处理时, 它可以忽略代码并执行默认动作, 或者忽略该子记录的父通用控制记录.

#### 数据记录

类型名为 "d" . 一条数据记录可以包含任意类型数据. 包含在数据记录中的数据应该简单地传递给目标函数. 如何解释数据记录中的内容取决于目标函数.